# ν”„λ΅ νΈμ—”λ“ μ—°λ™ μ‘μ—… κ³„ν

**μ‘μ„±μΌ**: 2025-12-11  
**μƒνƒ**: μ§„ν–‰ μ¤‘

---

## π“‹ κ°μ”

ν”„λ΅ νΈμ—”λ“ λ‹΄λ‹Ήμλ΅λ¶€ν„° κ³µμ΅° λ©”μΌμ„ λ°›μ•„ WebSocket ν”„λ΅ν† μ½ λ° API μ—°λ™μ„ μ„ν• μ‘μ—… κ³„νμ„ μλ¦½ν–μµλ‹λ‹¤.

---

## π” ν„μ¬ μƒνƒ λ¶„μ„

### β… μ™„λ£λ λ°±μ—”λ“ κΈ°λ¥
- [x] κΈ°λ³Έ κ²μ„ λ΅μ§ κµ¬ν„ (GameManager, TurnManager, ActionHandler, CardManager)
- [x] WebSocket κΈ°λ³Έ μ—°κ²° κµ¬ν„ (ConnectionManager, MessageHandler)
- [x] κ²μ„ μƒνƒ κ΄€λ¦¬ λ° μ „μ†΅ κΈ°λ¥
- [x] ν”λ μ΄μ–΄ μ•΅μ… μ²λ¦¬ (USE_CARD, END_TURN, RESPOND_ATTACK)

### β οΈ ν”„λ΅ νΈμ—”λ“ μ”μ²­μ‚¬ν•­κ³Όμ μ°¨μ΄μ 

#### 1. WebSocket μ—”λ“ν¬μΈνΈ URL ν•μ‹
- **ν„μ¬**: `/ws/{player_id}`
- **μ”μ²­**: `/lobby/{gameId}?player={playerName}` λλ” `/game/{gameId}?player={playerId}`
- **μ°¨μ΄**: URL κµ¬μ΅°μ™€ νλΌλ―Έν„° μ „λ‹¬ λ°©μ‹μ΄ λ‹¤λ¦„

#### 2. λ©”μ‹μ§€ ν”„λ΅ν† μ½ ν•μ‹
- **ν„μ¬ ν΄λΌμ΄μ–ΈνΈ β†’ μ„λ²„**:
  ```json
  {
    "type": "PLAYER_ACTION",
    "action_type": "USE_CARD",
    "data": {...}
  }
  ```
- **μ”μ²­ ν•μ‹**:
  ```json
  {
    "type": "PLAYER_ACTION",
    "action": {
      "type": "USE_CARD",
      "cardId": "string",
      "targetId": "string",
      "response": "evade" | "give_up"
    }
  }
  ```

#### 3. κ²μ„ μƒνƒ μ—…λ°μ΄νΈ λ©”μ‹μ§€ ν•μ‹
- **ν„μ¬**: `{"type": "GAME_STATE_UPDATE", "data": {...}}`
- **μ”μ²­**: 
  ```json
  {
    "type": "GAME_STATE_UPDATE",
    "gameId": "string",
    "players": [...],
    "currentTurn": "string",
    "turnState": {...},
    "events": [...],
    "phase": "lobby" | "playing" | "finished"
  }
  ```

#### 4. λ„λ½λ κΈ°λ¥
- λ΅λΉ„ μ—°κ²° μ—”λ“ν¬μΈνΈ (`/lobby/{gameId}`)
- κ²μ„ μ‹μ‘ ν”„λ΅ν† μ½
- κ²μ„ μ΄λ²¤νΈ λ΅κ·Έ μ‹μ¤ν…
- ν„΄ νƒ€μ΄λ¨Έ κ΄€λ¦¬
- μ—λ¬ μ½”λ“ μ²΄κ³„

---

## π― μ‘μ—… κ³„ν

### Phase 1: WebSocket μ—”λ“ν¬μΈνΈ μμ • (μ°μ„ μμ„: λ†’μ)

#### 1.1 λ΅λΉ„ μ—”λ“ν¬μΈνΈ μ¶”κ°€
- [x] `/lobby/{game_id}` WebSocket μ—”λ“ν¬μΈνΈ κµ¬ν„
- [x] μΏΌλ¦¬ νλΌλ―Έν„°λ΅ `player` μ΄λ¦„ λ°›κΈ°
- [x] ν”λ μ΄μ–΄ ID μλ™ μƒμ„± (UUID)
- [x] μ—°κ²° μ„±κ³µ μ‹ μλ™ κ²μ„ μ°Έκ°€ μ²λ¦¬
- [x] ν”λ μ΄μ–΄ μ°Έκ°€ μ‹ μλ™ κ²μ„ μƒνƒ μ „μ†΅

**νμΌ**: `app/main.py`, `app/websocket/message_handler.py`

#### 1.2 κ²μ„ μ—”λ“ν¬μΈνΈ μ¶”κ°€ (μ„ νƒμ‚¬ν•­)
- [ ] `/game/{game_id}` WebSocket μ—”λ“ν¬μΈνΈ κµ¬ν„
- [ ] κ²μ„ μ§„ν–‰ μ¤‘ μ—°κ²° μ§€μ›

**νμΌ**: `app/main.py`

---

### Phase 2: λ©”μ‹μ§€ ν”„λ΅ν† μ½ ν‘μ¤€ν™” (μ°μ„ μμ„: λ†’μ)

#### 2.1 ν΄λΌμ΄μ–ΈνΈ β†’ μ„λ²„ λ©”μ‹μ§€ ν•μ‹ λ³€κ²½
- [ ] `PLAYER_ACTION` λ©”μ‹μ§€ ν•μ‹μ„ ν”„λ΅ νΈμ—”λ“ μ”μ²­ ν•μ‹μΌλ΅ λ³€κ²½
  - `action_type` β†’ `action.type`
  - `data` β†’ `action` λ‚΄λ¶€λ΅ ν†µν•©
- [ ] `MessageHandler.handle_player_action()` μμ •
- [ ] `ActionHandler` νΈμ¶ λ¶€λ¶„ μμ •

**νμΌ**: `app/websocket/message_handler.py`, `app/game/action_handler.py`

#### 2.2 μ„λ²„ β†’ ν΄λΌμ΄μ–ΈνΈ λ©”μ‹μ§€ ν•μ‹ λ³€κ²½
- [ ] `GAME_STATE_UPDATE` λ©”μ‹μ§€ ν•μ‹μ„ ν”„λ΅ νΈμ—”λ“ μ”μ²­ ν•μ‹μΌλ΅ λ³€κ²½
- [ ] `Game.to_dict()` λ©”μ„λ“ μμ • λλ” μƒλ΅μ΄ λ³€ν™ λ©”μ„λ“ μ¶”κ°€
- [ ] ν”λ μ΄μ–΄ μ •λ³΄ κµ¬μ΅° λ³€κ²½:
  - `role` β†’ μ—­ν•  μ΄λ¦„ λ¬Έμμ—΄
  - `hp` β†’ μ¬λ ¥
  - `range` β†’ `influence` (μν–¥λ ¥)
  - `hand` β†’ μΉ΄λ“ μ •λ³΄ λ°°μ—΄ (λ‹¤λ¥Έ ν”λ μ΄μ–΄λ” κ°μλ§)
  - `tableCards` β†’ ν•„λ“μ— λ‚΄λ ¤λ†“μ€ μΉ΄λ“
  - `treasures` β†’ λ³΄λ¬Ό ID λ°°μ—΄

**νμΌ**: `app/models/game.py`, `app/models/player.py`, `app/websocket/message_handler.py`

---

### Phase 3: κ²μ„ μƒνƒ κµ¬μ΅° κ°μ„  (μ°μ„ μμ„: μ¤‘κ°„)

#### 3.1 ν„΄ μƒνƒ μ •λ³΄ μ¶”κ°€
- [ ] `turnState` κ°μ²΄ κµ¬μ΅°ν™”:
  - `currentTurn`: ν„μ¬ ν„΄ ν”λ μ΄μ–΄ ID
  - `timeLeft`: λ‚¨μ€ μ‹κ°„ (μ΄)
  - `requiredResponse`: μ‘λ‹µ ν•„μ” μ‹ μ •λ³΄ (optional)
- [ ] ν„΄ νƒ€μ΄λ¨Έ κ΄€λ¦¬ λ΅μ§ μ¶”κ°€ (μ„λ²„ μΈ΅)

**νμΌ**: `app/game/turn_manager.py`, `app/models/game.py`

#### 3.2 κ²μ„ μ΄λ²¤νΈ λ΅κ·Έ μ‹μ¤ν…
- [ ] κ²μ„ μ΄λ²¤νΈ λ΅κ·Έ μ €μ¥ λ° κ΄€λ¦¬
- [ ] `events` λ°°μ—΄μ— μµκ·Ό 50κ° μ΄λ²¤νΈ ν¬ν•¨
- [ ] μ΄λ²¤νΈ νƒ€μ…: `action`, `notification`, `error`
- [ ] μ΄λ²¤νΈ κµ¬μ΅°:
  ```json
  {
    "id": "string",
    "timestamp": "number (Unix timestamp, λ°€λ¦¬μ΄)",
    "message": "string",
    "type": "action" | "notification" | "error"
  }
  ```

**νμΌ**: `app/models/game.py`, `app/game/action_handler.py`

#### 3.3 κ²μ„ λ‹¨κ³„(Phase) κ΄€λ¦¬
- [ ] `phase` ν•„λ“ μ¶”κ°€: `"lobby" | "playing" | "finished"`
- [ ] κ²μ„ μƒνƒμ™€ μ—°λ™

**νμΌ**: `app/models/game.py`

---

### Phase 4: μ—λ¬ μ²λ¦¬ κ°μ„  (μ°μ„ μμ„: μ¤‘κ°„)

#### 4.1 μ—λ¬ μ½”λ“ μ²΄κ³„ κµ¬μ¶•
- [ ] μ—λ¬ μ½”λ“ μ •μ (`app/utils/constants.py` λλ” λ³„λ„ νμΌ)
- [ ] μ—λ¬ μ½”λ“ μμ‹:
  - `INVALID_ACTION`: μλ»λ μ•΅μ…
  - `NOT_YOUR_TURN`: μμ‹ μ ν„΄μ΄ μ•„λ‹
  - `INVALID_TARGET`: μλ»λ νƒ€κ²
  - `CARD_NOT_FOUND`: μΉ΄λ“λ¥Ό μ°Ύμ„ μ μ—†μ
  - `GAME_NOT_FOUND`: κ²μ„μ„ μ°Ύμ„ μ μ—†μ
  - `PLAYER_NOT_FOUND`: ν”λ μ΄μ–΄λ¥Ό μ°Ύμ„ μ μ—†μ
- [ ] `ERROR` λ©”μ‹μ§€μ— `code` ν•„λ“ ν¬ν•¨

**νμΌ**: `app/utils/constants.py`, `app/websocket/message_handler.py`

---

### Phase 5: κ²μ„ μ‹μ‘ ν”„λ΅ν† μ½ (μ°μ„ μμ„: μ¤‘κ°„)

#### 5.1 κ²μ„ μ‹μ‘ λ©”μ‹μ§€ μ²λ¦¬
- [ ] κ²μ„ μ‹μ‘ μ”μ²­ λ©”μ‹μ§€ νƒ€μ… μ •μ
- [ ] μµμ† ν”λ μ΄μ–΄ μ ν™•μΈ
- [ ] κ²μ„ μ‹μ‘ μ‹ λ¨λ“  ν”λ μ΄μ–΄μ—κ² μƒνƒ μ „μ†΅
- [ ] ν”„λ΅ νΈμ—”λ“μ™€ ν‘μ ν•„μ”: μλ™ μ‹μ‘ vs μλ™ μ‹μ‘

**νμΌ**: `app/websocket/message_handler.py`, `app/game/game_manager.py`

---

### Phase 6: ν”λ μ΄μ–΄ ID κ΄€λ¦¬ (μ°μ„ μμ„: λ‚®μ)

#### 6.1 ν”λ μ΄μ–΄ ID λ°κΈ‰ λ°©μ‹ κ²°μ •
- [ ] ν”„λ΅ νΈμ—”λ“μ™€ ν‘μ: μ„λ²„ λ°κΈ‰ vs ν΄λΌμ΄μ–ΈνΈ μ κ³µ
- [ ] ν„μ¬λ” ν΄λΌμ΄μ–ΈνΈμ—μ„ `playerName` μ κ³µ β†’ μ„λ²„μ—μ„ ID μƒμ„± ν•„μ”ν•  μ μμ

**νμΌ**: `app/websocket/message_handler.py`

---

### Phase 7: νƒ€κ²ν… κ²€μ¦ (μ°μ„ μμ„: λ‚®μ)

#### 7.1 μν–¥λ ¥ λ²”μ„ κ²€μ¦
- [ ] μ„λ²„ μΈ΅ νƒ€κ²ν… κ²€μ¦ κ°•ν™”
- [ ] `ActionHandler`μ—μ„ κ±°λ¦¬ κ²€μ¦ λ΅μ§ ν™•μΈ λ° κ°μ„ 

**νμΌ**: `app/game/action_handler.py`

---

### Phase 8: ν…μ¤νΈ λ° λ¬Έμ„ν™” (μ°μ„ μμ„: λ†’μ)

#### 8.1 WebSocket ν”„λ΅ν† μ½ λ¬Έμ„ μ‘μ„±
- [ ] λ©”μ‹μ§€ ν”„λ΅ν† μ½ μƒμ„Έ λ¬Έμ„ μ‘μ„±
- [ ] μ—λ¬ μ½”λ“ λ©λ΅ λ¬Έμ„ν™”
- [ ] κ²μ„ μƒνƒ μ „μ΄ λ‹¤μ΄μ–΄κ·Έλ¨ (κ°€λ¥ν•λ©΄)

**νμΌ**: `docs/fastapi/features/websocket-protocol.md` (μ‹ κ·)

#### 8.2 μ—°λ™ ν…μ¤νΈ
- [ ] ν”„λ΅ νΈμ—”λ“μ™€ κΈ°λ³Έ μ—°κ²° ν…μ¤νΈ
- [ ] λ©”μ‹μ§€ μ†΅μμ‹  ν…μ¤νΈ
- [ ] κ²μ„ ν”λ΅μ° ν…μ¤νΈ

---

## π“ ν‘μ ν•„μ” μ‚¬ν•­

### 1. κ²μ„ μ‹μ‘ ν”„λ΅ν† μ½
- **μ§λ¬Έ**: κ²μ„ μ‹μ‘μ€ λ³„λ„ λ©”μ‹μ§€κ°€ ν•„μ”ν•κ°€μ”?
- **μ μ•**: `START_GAME` λ©”μ‹μ§€ νƒ€μ… μ¶”κ°€ λλ” λ΅λΉ„μ—μ„ μλ™ μ‹μ‘

### 2. ν”λ μ΄μ–΄ ID κ΄€λ¦¬
- **μ§λ¬Έ**: λ΅λΉ„ μ°Έκ°€ μ‹ μ„λ²„μ—μ„ ν”λ μ΄μ–΄ IDλ¥Ό λ°κΈ‰ν•λ‚μ”?
- **μ μ•**: μ„λ²„μ—μ„ UUID κΈ°λ° ID λ°κΈ‰ ν›„ ν΄λΌμ΄μ–ΈνΈμ— μ „λ‹¬

### 3. ν•Έλ“ μΉ΄λ“ μ •λ³΄
- **ν„μ¬ κµ¬ν„**: λ‹¤λ¥Έ ν”λ μ΄μ–΄μ ν•Έλ“λ” κ°μλ§ ν‘μ‹ (`hand_count`)
- **ν™•μΈ ν•„μ”**: ν”„λ΅ νΈμ—”λ“ μ”κµ¬μ‚¬ν•­κ³Ό μΌμΉν•λ”μ§€ ν™•μΈ

### 4. νƒ€κ²ν… κ²€μ¦
- **ν„μ¬ κµ¬ν„**: μ„λ²„μ—μ„ κ±°λ¦¬ κ²€μ¦ μν–‰ (`ActionHandler`)
- **ν™•μΈ ν•„μ”**: μ¶”κ°€ κ²€μ¦μ΄ ν•„μ”ν•μ§€ ν™•μΈ

### 5. ν„΄ νƒ€μ΄λ¨Έ
- **μ§λ¬Έ**: ν„΄ νƒ€μ΄λ¨Έλ” μ„λ²„μ—μ„ κ΄€λ¦¬ν•λ‚μ”?
- **μ μ•**: μ„λ²„μ—μ„ νƒ€μ΄λ¨Έ κ΄€λ¦¬, μ£ΌκΈ°μ μΌλ΅ `timeLeft` μ—…λ°μ΄νΈ μ „μ†΅

### 6. μ—λ¬ μ½”λ“
- **μ μ•**: μ—λ¬ μ½”λ“ μ²΄κ³„ κµ¬μ¶• (μ„ Phase 4 μ°Έμ΅°)

### 7. κ²μ„ μ΄λ²¤νΈ λ΅κ·Έ
- **μ μ•**: μ„λ²„μ—μ„ μ΄λ²¤νΈ λ΅κ·Έ μƒμ„± λ° μ „μ†΅ (μ„ Phase 3.2 μ°Έμ΅°)

---

## π—“οΈ μΌμ • μ μ•

### 1μ£Όμ°¨: κΈ°λ³Έ ν”„λ΅ν† μ½ μμ •
- Phase 1: WebSocket μ—”λ“ν¬μΈνΈ μμ •
- Phase 2: λ©”μ‹μ§€ ν”„λ΅ν† μ½ ν‘μ¤€ν™”
- **λ©ν‘**: ν”„λ΅ νΈμ—”λ“μ™€ κΈ°λ³Έ μ—°κ²° λ° λ©”μ‹μ§€ μ†΅μμ‹  κ°€λ¥

### 2μ£Όμ°¨: κΈ°λ¥ λ³΄μ™„
- Phase 3: κ²μ„ μƒνƒ κµ¬μ΅° κ°μ„ 
- Phase 4: μ—λ¬ μ²λ¦¬ κ°μ„ 
- Phase 5: κ²μ„ μ‹μ‘ ν”„λ΅ν† μ½
- **λ©ν‘**: κ²μ„ ν”λ΅μ° μ „μ²΄ ν…μ¤νΈ κ°€λ¥

### 3μ£Όμ°¨: μµμ ν™” λ° λ¬Έμ„ν™”
- Phase 6-7: μ¶”κ°€ κΈ°λ¥
- Phase 8: ν…μ¤νΈ λ° λ¬Έμ„ν™”
- **λ©ν‘**: ν”„λ΅λ•μ… μ¤€λΉ„ μ™„λ£

---

## π“ μ¦‰μ‹ μ‹μ‘ κ°€λ¥ν• μ‘μ—…

### μ°μ„ μμ„ 1: λ©”μ‹μ§€ ν”„λ΅ν† μ½ μμ •
1. `PLAYER_ACTION` λ©”μ‹μ§€ ν•μ‹ λ³€κ²½
2. `GAME_STATE_UPDATE` λ©”μ‹μ§€ ν•μ‹ λ³€κ²½
3. κΈ°λ³Έ μ—°κ²° ν…μ¤νΈ

### μ°μ„ μμ„ 2: λ΅λΉ„ μ—”λ“ν¬μΈνΈ μ¶”κ°€
1. `/lobby/{game_id}` μ—”λ“ν¬μΈνΈ κµ¬ν„
2. ν”λ μ΄μ–΄ μ°Έκ°€ λ΅μ§ μμ •
3. κ²μ„ μƒνƒ μ „μ†΅ ν•μ‹ ν™•μΈ

---

## π”— κ΄€λ ¨ νμΌ λ©λ΅

### μμ • ν•„μ” νμΌ
- `app/main.py` - WebSocket μ—”λ“ν¬μΈνΈ μ¶”κ°€/μμ •
- `app/websocket/message_handler.py` - λ©”μ‹μ§€ μ²λ¦¬ λ΅μ§ μμ •
- `app/models/game.py` - κ²μ„ μƒνƒ λ³€ν™ λ΅μ§ μμ •
- `app/models/player.py` - ν”λ μ΄μ–΄ μ •λ³΄ λ³€ν™ λ΅μ§ μμ •
- `app/game/action_handler.py` - μ•΅μ… μ²λ¦¬ λ΅μ§ μμ • (ν•„μ”μ‹)
- `app/utils/constants.py` - μ—λ¬ μ½”λ“ μ¶”κ°€

### μ‹ κ· μƒμ„± νμΌ
- `docs/fastapi/features/websocket-protocol.md` - WebSocket ν”„λ΅ν† μ½ λ¬Έμ„
- `app/utils/error_codes.py` - μ—λ¬ μ½”λ“ μ •μ (μ„ νƒμ‚¬ν•­)

---

## π“ λ‹¤μ λ‹¨κ³„

1. **ν”„λ΅ νΈμ—”λ“ λ‹΄λ‹Ήμμ™€ ν‘μ μ‚¬ν•­ λ…Όμ**
2. **Phase 1, 2 μ‘μ—… μ‹μ‘** (λ©”μ‹μ§€ ν”„λ΅ν† μ½ μμ •)
3. **κΈ°λ³Έ μ—°κ²° ν…μ¤νΈ μ§„ν–‰**
4. **ν”Όλ“λ°± λ°μ λ° μ¶”κ°€ μ‘μ—…**

---

**μ‘μ„±μ**: λ°±μ—”λ“ κ°λ°μ  
**μµμΆ… μ—…λ°μ΄νΈ**: 2025-12-11

