# 작업일지 - 2025-12-12

## 작업 시간
- 시작: [시간]
- 종료: [시간]
- 총 작업 시간: [시간]

## 완료한 작업
- [x] ImportError 수정 (서버 담당자 요청)
  - [x] `app/utils/constants.py`에 누락된 상수 추가
    - [x] `MIN_PLAYERS = 4` 추가
    - [x] `MAX_PLAYERS = 7` 추가
    - [x] `WS_MAX_CONNECTIONS = 100` 추가
    - [x] `WS_HEARTBEAT_INTERVAL = 30` 추가
  - [x] Import 테스트 완료
- [x] 향후 작업 계획 문서 작성
  - [x] `docs/FUTURE_WORK_PLAN.md` 생성
    - [x] 우선순위별 작업 계획 수립
    - [x] 단기/중기/장기 작업 정리
    - [x] 프론트엔드 연동 준비 작업 계획
- [x] GitHub Actions 자동 배포 성공 확인
  - [x] Tailscale VPN 연동 정상 작동
  - [x] 서비스 배포 성공
  - [x] ImportError 발견 및 수정
- [x] 로비 엔드포인트 구현 (`/lobby/{game_id}`)
  - [x] `/lobby/{game_id}?player={playerName}` WebSocket 엔드포인트 추가
  - [x] 플레이어 ID 자동 생성 (UUID)
  - [x] 연결 성공 시 자동 게임 참가 처리
  - [x] `GAME_STATE_UPDATE` 메시지 자동 전송
  - [x] 에러 처리 및 연결 관리
- [x] 게임 시작 프로토콜 구현
  - [x] `START_GAME` 메시지 타입 처리 로직 추가
  - [x] 최소 플레이어 수 확인 (4명 이상)
  - [x] 게임 상태 검증 (WAITING 상태만 시작 가능)
  - [x] 게임 시작 시 역할 배정 및 초기화
  - [x] 게임 시작 이벤트 로그 추가
  - [x] 모든 플레이어에게 게임 상태 브로드캐스트
  - [x] 에러 처리 (게임 ID, 플레이어 참여 여부, 게임 상태 등)

## 진행 중인 작업
- [ ] 프론트엔드와 WebSocket 연결 테스트

## 완료한 작업 (추가)
- [x] AI 플레이어 추가 기능 구현
  - [x] `ADD_AI_PLAYER` 메시지 타입 처리
  - [x] Player 모델에 `isBot` 필드 추가
  - [x] GameManager에 `add_ai_players_to_game()` 메서드 구현
  - [x] AI 플레이어 생성 및 게임 추가 로직
  - [x] 난이도별 AI 플레이어 이름 생성 (Easy/Medium/Hard)
  - [x] 검증 로직 (최대 플레이어 수, 게임 상태)
  - [x] 에러 처리 및 응답 메시지
  - [x] 게임 상태 브로드캐스트
- [x] 프론트엔드 연동 준비 문서 작성
  - [x] `docs/FRONTEND_COORDINATION_RESPONSE.md` 생성
  - [x] `docs/WEBSOCKET_CONNECTION_TROUBLESHOOTING.md` 생성
- [x] 서버 실행 스크립트 생성
  - [x] `start_server.ps1` (PowerShell)
  - [x] `start_server.bat` (CMD)
- [x] AI 플레이어 추가 기능 테스트
  - [x] 테스트 스크립트 작성 (`test_ai_complete.py`, `test_ai_simple.py`)
  - [x] 최소 인원(4명)까지 AI 추가 테스트
  - [x] 게임 시작 테스트
  - [x] UTF-8 인코딩 문제 수정

## 이슈 및 해결

### 이슈: ImportError 발생 (서버 배포 시)
- **문제**: 서버 배포 후 `ImportError: cannot import name 'MIN_PLAYERS' from 'app.utils.constants'` 발생
- **원인**: `app/game/game_manager.py`와 `app/websocket/connection_manager.py`에서 `app.utils.constants`에서 상수를 import하려 했으나, 해당 파일에 정의되지 않음
- **해결**: `app/utils/constants.py`에 다음 상수 추가
  - `MIN_PLAYERS = 4`
  - `MAX_PLAYERS = 7`
  - `WS_MAX_CONNECTIONS = 100`
  - `WS_HEARTBEAT_INTERVAL = 30`
- **결과**: Import 테스트 성공, 서버에서 임시 수정 후 정상 작동 확인

### 이슈: GitHub Actions 자동 배포 성공
- **상태**: ✅ 성공
- **Tailscale 연결**: 정상 작동
- **서비스 상태**: `active (running)`
- **접속 URL**: `https://ledger-weight-api.livbee.co.kr`

## 학습 및 참고 자료
- Tailscale VPN 설정
- GitHub Actions CI/CD
- Python 상수 관리 패턴

## 다음 작업 계획
- [ ] 프론트엔드와 WebSocket 연결 테스트
- [ ] 턴 타이머 구현
- [ ] 에러 코드 체계 구축
- [ ] 타겟팅 검증 강화

## 메모
- 서버 배포 성공적으로 완료됨
- 자동 배포 시스템 정상 작동 중
- 로비 엔드포인트 구현 완료, 프론트엔드 연동 준비 완료
- 상세 작업 계획은 `docs/FUTURE_WORK_PLAN.md` 참고

### 로비 엔드포인트 구현 상세
- **엔드포인트**: `/lobby/{game_id}?player={playerName}`
- **기능**:
  - 플레이어 이름을 쿼리 파라미터로 받음
  - 서버에서 UUID 기반 플레이어 ID 자동 생성
  - 연결 성공 시 자동으로 게임 참가 처리
  - `CONNECTION_ESTABLISHED` 메시지 전송 (플레이어 ID 포함)
  - `GAME_STATE_UPDATE` 메시지 자동 전송
  - 참가 실패 시 에러 메시지 전송 후 연결 종료
- **파일**: `app/main.py`

### 게임 시작 프로토콜 구현 상세
- **메시지 타입**: `START_GAME`
- **기능**:
  - 게임 ID 확인 (메시지 또는 플레이어가 속한 게임)
  - 게임 존재 여부 및 플레이어 참여 여부 확인
  - 게임 상태 검증 (WAITING 상태만 시작 가능)
  - 최소 플레이어 수 확인 (4명 이상)
  - `GameManager.start_game()` 호출:
    - 역할 배정 (플레이어 수에 따라)
    - 카드 덱 생성 및 셔플
    - 초기 카드 분배
    - 게임 상태를 `IN_PROGRESS`로 변경
    - 첫 번째 플레이어(상단주) 설정
  - 게임 시작 이벤트 로그 추가
  - 모든 플레이어에게 `GAME_STATE_UPDATE` 브로드캐스트 (phase: "playing")
- **에러 처리**:
  - 게임 ID 없음 또는 플레이어 미참여
  - 게임을 찾을 수 없음
  - 플레이어가 게임에 참여하지 않음
  - 게임이 이미 시작되었거나 종료됨
  - 최소 플레이어 수 미달
- **파일**: `app/websocket/message_handler.py`

### AI 플레이어 추가 기능 구현 상세
- **메시지 타입**: `ADD_AI_PLAYER`
- **기능**:
  - 게임 ID 확인 (메시지 또는 플레이어가 속한 게임)
  - 게임 존재 여부 및 플레이어 참여 여부 확인
  - 게임 상태 검증 (WAITING 상태만 추가 가능)
  - 최대 플레이어 수 확인 (7명)
  - AI 플레이어 생성 및 게임 추가:
    - 난이도별 이름 생성 (AI_Easy_1, AI_Player_1, AI_Hard_1)
    - UUID 기반 AI 플레이어 ID 생성
    - `isBot: true` 필드 설정
  - AI 추가 이벤트 로그 추가
  - 모든 플레이어에게 `GAME_STATE_UPDATE` 브로드캐스트
- **에러 처리**:
  - 게임 ID 없음 또는 플레이어 미참여
  - 게임을 찾을 수 없음
  - 플레이어가 게임에 참여하지 않음
  - 게임이 이미 시작되었거나 종료됨
  - 최대 플레이어 수 초과
  - 잘못된 AI 플레이어 수 (0 이하 또는 최대값 초과)
  - 잘못된 난이도 값
- **파일**: `app/websocket/message_handler.py`, `app/game/game_manager.py`, `app/models/player.py`

### 버그 수정
- **이슈**: `use_enum_values = True`로 인한 Enum 값 접근 오류
  - **문제**: `'str' object has no attribute 'value'` 에러 발생
  - **원인**: Pydantic의 `use_enum_values = True` 설정으로 Enum이 자동으로 값으로 변환됨
  - **해결**: 
    - `Game.__str__`, `Game.__repr__` 수정
    - `Card.to_dict()`, `Card.__str__`, `Card.__repr__` 수정
    - `Player.to_dict()` 수정
    - `Role.__init__`에 타입 체크 추가
- **이슈**: `Game.add_event()` 메서드 호출 시 키워드 인자 오류
  - **문제**: `Game.add_event() got an unexpected keyword argument 'message'`
  - **해결**: 위치 인자로 변경 (`game.add_event(message, event_type)`)

